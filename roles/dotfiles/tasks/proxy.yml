# https://www.everythingcli.org/ssh-tunnelling-for-fun-and-profit-autossh/
# https://linux.die.net/man/1/autossh

- name: install autossh, proxychains
  become: yes
  ansible.builtin.package:
    name:
      - autossh
      - proxychains
    state: latest

- name: configure proxychains
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/proxychains.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.replace }}"
  with_items:
    - { regexp: "^#?socks5 .*", replace: "socks5         127.0.0.1 {{ lookup('env', 'PROXY_SOCKS_PORT') }}" }
    - { regexp: "^#?(socks4 .*)", replace: "#socks4         127.0.0.1 9050" }

- name: install proxy systemd services
  become: yes
  ansible.builtin.template:
    src: "{{ item }}.service"
    dest: /etc/systemd/system/{{ item }}.service
  with_items:
    - proxy-socks
    - proxy-https

- name: force systemd to reread configs
  become: yes
  ansible.builtin.systemd:
    daemon_reload: yes

- name: enable and restart proxy services
  become: yes
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: yes
    state: restarted
  with_items:
    - proxy-socks
    - proxy-https
